<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <title>Data Filter</title>
    
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 8px;
        }
    </style>
</head>
<body class="container">

	<div class="w-100 d-flex col-12 row">
		<div class="col-sm align-self-center">
			<h1>Filter Warehouse Data</h1>
			<div class="input-group mb-3 w-50">
			  <input class="form-control" type="text" id="search-input" placeholder="Search...">
			</div>
		</div>
		<div class="col-sm m-auto">
			<h5>Update Google Sheet Link</h5>
			<div id="update-link-container" class="d-flex justify-content-between">
				<div class="input-group mb-3 w-50">
					<input type="text" id="password-input" class="form-control" placeholder="Enter password">
				</div>
				<div>
				<button id="update-link-btn " class="btn btn-primary" >Update Link</button>
				<p id="feedback"></p>
				</div>
			</div>
		</div>
	</div>

    <br><br>
	 <p id="loading">Loading data...</p>
    <!-- Table to display data -->
    <div class="table-responsive" style="height:70vh;">
    <table id="excel-table table" class="table table-hover table-striped" >
        <thead  class="table-primary" style="position:sticky;top:0;">
            <tr id="table-header"></tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>
    </div>
	
    <script>
        // Replace with your actual Google Sheet's export CSV link
        const googleSheetUrl = "https://docs.google.com/spreadsheets/d/1CIXqlAczg5xh0eB0D7Itje9fWXG-y0ZtVFVA-lBoWDE/export?format=csv"; 
	const correctPassword = "mySecurePassword"; 
       //let googleSheetUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(googleLink);

         let sheetData = [];
        let sheetDataLower = [];
        let headers = [];

        async function fetchSheetData() {
            try {
                const response = await fetch(googleSheetUrl);
                const csv = await response.text();
                parseCSV(csv);
            } catch (error) {
                console.error('Error fetching Google Sheet:', error);
            }
        }

        function parseCSV(csv) {
            const rows = csv.trim().split("\n").map(row => row.split(","));
            headers = rows[0];
            sheetData = rows.slice(1);
            
            // Pre-cache lowercase version for fast searching
            sheetDataLower = sheetData.map(row => row.map(cell => cell.toLowerCase()));

            renderTable(sheetData);
        }

        function renderTable(data) {
            const headerRow = document.getElementById('table-header');
            const bodyRow = document.getElementById('table-body');

            // Render headers once
            headerRow.innerHTML = headers.map(header => `<th>${header}</th>`).join("");

            // Use a fragment to improve performance
            let tableHTML = data.map(row => 
                `<tr>${row.map(cell => `<td>${cell}</td>`).join("")}</tr>`
            ).join("");

            bodyRow.innerHTML = tableHTML;
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function searchTable() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            if (!searchText) {
                renderTable(sheetData); // Restore full data when empty
                return;
            }

            // Use pre-lowered data for efficient matching
            const filteredData = sheetData.filter((row, index) => 
                sheetDataLower[index].some(cell => cell.includes(searchText))
            );

            renderTable(filteredData);
        }

        document.getElementById('search-input').addEventListener('input', debounce(searchTable, 100));

        fetchSheetData();

	    // Handle password input to update Google Sheets link
        document.getElementById('update-link-btn').addEventListener('click', function() {
            const enteredPassword = document.getElementById('password-input').value;

            if (enteredPassword === correctPassword) {
                const newLink = prompt("Enter the new Google Sheets CSV link:");

                if (newLink) {
                    googleSheetUrl = newLink; // Update the URL
                    fetchSheetData(); // Re-fetch the data with the new link
                    document.getElementById('feedback').style.display = 'none';
                }
            } else {
                document.getElementById('feedback').textContent = "Incorrect password!";
                document.getElementById('feedback').style.display = 'block';
            }
        });
    </script>

</body>
</html>
